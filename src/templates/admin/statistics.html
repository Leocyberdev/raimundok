{% extends "admin/base.html" %}

{% block page_title %}Estatísticas{% endblock %}

{% block extra_css %}
{{ super() }}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
    .stats-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 30px;
        flex-wrap: wrap;
        gap: 15px;
    }
    
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }
    
    .stat-card {
        background: white;
        padding: 25px;
        border-radius: 15px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        border-left: 4px solid #3b82f6;
        transition: all 0.3s ease;
    }
    
    .stat-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 20px rgba(0, 0, 0, 0.15);
    }
    
    .stat-card.success {
        border-left-color: var(--success-color);
    }
    
    .stat-card.warning {
        border-left-color: var(--warning-color);
    }
    
    .stat-card.info {
        border-left-color: #06b6d4;
    }
    
    .stat-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
    }
    
    .stat-title {
        color: var(--secondary-color);
        font-size: 0.9rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    .stat-icon {
        width: 45px;
        height: 45px;
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.2rem;
        color: white;
        background: linear-gradient(135deg, #3b82f6, #1d4ed8);
    }
    
    .stat-value {
        font-size: 2rem;
        font-weight: 700;
        color: var(--dark-color);
        margin: 0;
    }
    
    .stat-change {
        font-size: 0.9rem;
        margin-top: 5px;
    }
    
    .stat-change.positive {
        color: var(--success-color);
    }
    
    .stat-change.negative {
        color: var(--danger-color);
    }
    
    .chart-container {
        background: white;
        border-radius: 15px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        padding: 30px;
        margin-bottom: 30px;
    }
    
    .chart-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        flex-wrap: wrap;
        gap: 15px;
    }
    
    .chart-title {
        font-weight: 600;
        color: var(--dark-color);
        margin: 0;
        display: flex;
        align-items: center;
        gap: 10px;
    }
    
    .chart-filters {
        display: flex;
        gap: 10px;
        align-items: center;
    }
    
    .filter-btn {
        padding: 6px 12px;
        border: 1px solid #e5e7eb;
        background: white;
        border-radius: 6px;
        font-size: 0.9rem;
        cursor: pointer;
        transition: all 0.3s ease;
    }
    
    .filter-btn.active {
        background: #3b82f6;
        border-color: #3b82f6;
        color: white;
    }
    
    .chart-canvas {
        position: relative;
        height: 300px;
        margin-top: 20px;
    }
    
    .insights-section {
        background: white;
        border-radius: 15px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        padding: 30px;
        margin-bottom: 30px;
    }
    
    .insight-item {
        display: flex;
        align-items: center;
        gap: 15px;
        padding: 15px;
        border-radius: 10px;
        margin-bottom: 15px;
        transition: all 0.3s ease;
    }
    
    .insight-item:hover {
        background: #f8fafc;
    }
    
    .insight-item:last-child {
        margin-bottom: 0;
    }
    
    .insight-icon {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1rem;
        color: white;
        flex-shrink: 0;
    }
    
    .insight-icon.success {
        background: var(--success-color);
    }
    
    .insight-icon.warning {
        background: var(--warning-color);
    }
    
    .insight-icon.info {
        background: #06b6d4;
    }
    
    .insight-content h6 {
        margin: 0 0 5px 0;
        font-weight: 600;
        color: var(--dark-color);
    }
    
    .insight-content p {
        margin: 0;
        color: var(--secondary-color);
        font-size: 0.9rem;
    }
    
    .performance-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }
    
    .performance-card {
        background: white;
        border-radius: 15px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        padding: 25px;
    }
    
    .performance-header {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 20px;
    }
    
    .performance-icon {
        width: 40px;
        height: 40px;
        border-radius: 10px;
        background: #3b82f6;
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    .performance-title {
        font-weight: 600;
        color: var(--dark-color);
        margin: 0;
    }
    
    .performance-metric {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px 0;
        border-bottom: 1px solid #f1f5f9;
    }
    
    .performance-metric:last-child {
        border-bottom: none;
    }
    
    .metric-label {
        color: var(--secondary-color);
        font-size: 0.9rem;
    }
    
    .metric-value {
        font-weight: 600;
        color: var(--dark-color);
    }
    
    @media (max-width: 768px) {
        .stats-header {
            flex-direction: column;
            align-items: stretch;
        }
        
        .chart-header {
            flex-direction: column;
            align-items: stretch;
        }
        
        .chart-filters {
            justify-content: center;
        }
        
        .performance-grid {
            grid-template-columns: 1fr;
        }
    }
</style>
{% endblock %}

{% block admin_content %}
<div class="stats-header">
    <div>
        <h2 class="mb-0">
            <i class="fas fa-chart-bar text-primary me-2"></i>
            Estatísticas e Relatórios
        </h2>
        <p class="text-muted mb-0">Acompanhe o desempenho e métricas dos pedidos</p>
    </div>
    
    <div class="d-flex gap-2">
        <button class="btn btn-outline-primary" onclick="exportReport()">
            <i class="fas fa-download me-2"></i>Exportar Relatório
        </button>
        <a href="{{ url_for('admin.calendar') }}" class="btn btn-outline-info">
            <i class="fas fa-calendar me-2"></i>Calendário
        </a>
    </div>
</div>

<!-- Estatísticas Principais -->
<div class="stats-grid">
    <div class="stat-card">
        <div class="stat-header">
            <div class="stat-title">Total de Pedidos</div>
            <div class="stat-icon">
                <i class="fas fa-clipboard-list"></i>
            </div>
        </div>
        <h2 class="stat-value">{{ total_orders }}</h2>
        <div class="stat-change positive">
            <i class="fas fa-arrow-up me-1"></i>+12% este mês
        </div>
    </div>
    
    <div class="stat-card warning">
        <div class="stat-header">
            <div class="stat-title">Em Produção</div>
            <div class="stat-icon" style="background: linear-gradient(135deg, var(--warning-color), #d97706);">
                <i class="fas fa-cogs"></i>
            </div>
        </div>
        <h2 class="stat-value">{{ in_production }}</h2>
        <div class="stat-change">
            <i class="fas fa-clock me-1"></i>Ativo agora
        </div>
    </div>
    
    <div class="stat-card success">
        <div class="stat-header">
            <div class="stat-title">Concluídos</div>
            <div class="stat-icon" style="background: linear-gradient(135deg, var(--success-color), #059669);">
                <i class="fas fa-check-circle"></i>
            </div>
        </div>
        <h2 class="stat-value">{{ completed }}</h2>
        <div class="stat-change positive">
            <i class="fas fa-arrow-up me-1"></i>+8% esta semana
        </div>
    </div>
    
    <div class="stat-card info">
        <div class="stat-header">
            <div class="stat-title">Taxa de Sucesso</div>
            <div class="stat-icon" style="background: linear-gradient(135deg, #06b6d4, #0891b2);">
                <i class="fas fa-percentage"></i>
            </div>
        </div>
        <h2 class="stat-value">
            {{ ((completed / total_orders * 100) | round(1)) if total_orders > 0 else 0 }}%
        </h2>
        <div class="stat-change positive">
            <i class="fas fa-arrow-up me-1"></i>Excelente
        </div>
    </div>
</div>

<!-- Gráficos -->
<div class="row">
    <!-- Gráfico de Status -->
    <div class="col-lg-6">
        <div class="chart-container">
            <div class="chart-header">
                <h5 class="chart-title">
                    <i class="fas fa-pie-chart"></i>
                    Distribuição por Status
                </h5>
            </div>
            <div class="chart-canvas">
                <canvas id="statusChart"></canvas>
            </div>
        </div>
    </div>
    
    <!-- Gráfico Mensal -->
    <div class="col-lg-6">
        <div class="chart-container">
            <div class="chart-header">
                <h5 class="chart-title">
                    <i class="fas fa-chart-line"></i>
                    Pedidos por Mês
                </h5>
                <div class="chart-filters">
                    <button class="filter-btn active" data-period="6">6 meses</button>
                    <button class="filter-btn" data-period="12">1 ano</button>
                </div>
            </div>
            <div class="chart-canvas">
                <canvas id="monthlyChart"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- Performance e Métricas -->
<div class="performance-grid">
    <div class="performance-card">
        <div class="performance-header">
            <div class="performance-icon">
                <i class="fas fa-clock"></i>
            </div>
            <h6 class="performance-title">Tempo Médio de Produção</h6>
        </div>
        
        <div class="performance-metric">
            <span class="metric-label">Tempo médio total</span>
            <span class="metric-value">5.2 dias</span>
        </div>
        <div class="performance-metric">
            <span class="metric-label">Mais rápido</span>
            <span class="metric-value">2 dias</span>
        </div>
        <div class="performance-metric">
            <span class="metric-label">Mais lento</span>
            <span class="metric-value">12 dias</span>
        </div>
    </div>
    
    <div class="performance-card">
        <div class="performance-header">
            <div class="performance-icon" style="background: var(--success-color);">
                <i class="fas fa-target"></i>
            </div>
            <h6 class="performance-title">Cumprimento de Prazos</h6>
        </div>
        
        <div class="performance-metric">
            <span class="metric-label">No prazo</span>
            <span class="metric-value">85%</span>
        </div>
        <div class="performance-metric">
            <span class="metric-label">Antecipados</span>
            <span class="metric-value">12%</span>
        </div>
        <div class="performance-metric">
            <span class="metric-label">Atrasados</span>
            <span class="metric-value">3%</span>
        </div>
    </div>
</div>

<!-- Insights e Recomendações -->
<div class="insights-section">
    <h5 class="mb-4">
        <i class="fas fa-lightbulb me-2"></i>
        Insights e Recomendações
    </h5>
    
    <div class="insight-item">
        <div class="insight-icon success">
            <i class="fas fa-thumbs-up"></i>
        </div>
        <div class="insight-content">
            <h6>Excelente Performance</h6>
            <p>Você está mantendo uma taxa de 85% de pedidos entregues no prazo. Continue assim!</p>
        </div>
    </div>
    
    <div class="insight-item">
        <div class="insight-icon info">
            <i class="fas fa-chart-line"></i>
        </div>
        <div class="insight-content">
            <h6>Tendência Positiva</h6>
            <p>O número de pedidos concluídos aumentou 8% esta semana comparado à semana anterior.</p>
        </div>
    </div>
    
    <div class="insight-item">
        <div class="insight-icon warning">
            <i class="fas fa-clock"></i>
        </div>
        <div class="insight-content">
            <h6>Atenção aos Prazos</h6>
            <p>Existem {{ in_production }} pedidos em produção. Monitore os prazos para evitar atrasos.</p>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
{{ super() }}
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
<script>
$(document).ready(function() {
    initializeCharts();
    setupFilters();
});

function initializeCharts() {
    // Gráfico de Status (Pizza)
    const statusCtx = document.getElementById("statusChart").getContext("2d");
    const statusData = [
        {% for item in status_counts %}
        {{ item.count }},
        {% endfor %}
    ];
    
    const statusLabels = [
        {% for item in status_counts %}
        '{{ item.status | title }}',
        {% endfor %}
    ];
    
    new Chart(statusCtx, {
        type: 'doughnut',
        data: {
            labels: statusLabels,
            datasets: [{
                data: statusData,
                backgroundColor: [
                    '#3788d8',
                    '#6366f1',
                    '#10b981',
                    '#059669'
                ],
                borderWidth: 2,
                borderColor: '#ffffff'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        padding: 20,
                        usePointStyle: true
                    }
                }
            }
        }
    });
    
    // Gráfico Mensal (Linha)
    const monthlyCtx = document.getElementById("monthlyChart").getContext("2d");
    const monthlyData = [
        {% for item in monthly_orders %}
        {{ item.count }},
        {% endfor %}
    ];
    
    const monthLabels = [
        {% for item in monthly_orders %}
        'Mês {{ item.month }}',
        {% endfor %}
    ];
    
    new Chart(monthlyCtx, {
        type: 'line',
        data: {
            labels: monthLabels,
            datasets: [{
                label: 'Pedidos',
                data: monthlyData,
                borderColor: '#3b82f6',
                backgroundColor: 'rgba(59, 130, 246, 0.1)',
                borderWidth: 3,
                fill: true,
                tension: 0.4,
                pointBackgroundColor: '#3b82f6',
                pointBorderColor: '#ffffff',
                pointBorderWidth: 2,
                pointRadius: 6
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    grid: {
                        color: '#f1f5f9'
                    }
                },
                x: {
                    grid: {
                        color: '#f1f5f9'
                    }
                }
            }
        }
    });
}

function setupFilters() {
    $('.filter-btn').on('click', function() {
        $(this).siblings().removeClass('active');
        $(this).addClass('active');
        
        const period = $(this).data('period');
        // Aqui você poderia recarregar os dados do gráfico baseado no período
        console.log('Filtro selecionado:', period);
    });
}

// --- FUNÇÃO DE EXPORTAÇÃO CORRIGIDA ---
function exportReport() {
    Swal.fire({
        title: 'Exportar Relatório',
        text: 'Escolha o formato de exportação:',
        icon: 'question',
        showCancelButton: true,
        confirmButtonText: '<i class="fas fa-file-pdf me-2"></i>Baixar PDF',
        cancelButtonText: '<i class="fas fa-print me-2"></i>Imprimir',
        reverseButtons: true,
        confirmButtonColor: '#3085d6',
        cancelButtonColor: '#6c757d'
    }).then((result) => {
        if (result.isConfirmed) {
            downloadReport();
        } else if (result.dismiss === Swal.DismissReason.cancel) {
            printReport();
        }
    });
}

function printReport() {
    window.print();
}

function downloadReport() {
    const element = document.querySelector('.admin-content'); // Seleciona o conteúdo principal do admin
    const options = {
        margin:       [0.5, 0.5, 0.5, 0.5],
        filename:     'relatorio_estatisticas_admin.pdf',
        image:        { type: 'jpeg', quality: 0.98 },
        html2canvas:  { scale: 2, useCORS: true, logging: false },
        jsPDF:        { unit: 'in', format: 'a4', orientation: 'portrait' }
    };
    html2pdf().from(element).set(options).save();
}

// Auto-refresh a cada 5 minutos
setInterval(function() {
    if (!document.hidden) {
        // location.reload(); // Descomente para reativar o auto-refresh
    }
}, 300000);
</script>
{% endblock %}

