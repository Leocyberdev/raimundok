{% extends "admin/base.html" %}

{% block page_title %}Calendário{% endblock %}

{% block extra_css %}
{{ super() }}
<link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.css" rel="stylesheet">
<style>
    .calendar-container {
        background: white;
        border-radius: 15px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        padding: 30px;
        margin-bottom: 30px;
    }
    
    .calendar-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 30px;
        flex-wrap: wrap;
        gap: 15px;
    }
    
    .calendar-filters {
        display: flex;
        gap: 10px;
        align-items: center;
        flex-wrap: wrap;
    }
    
    .filter-btn {
        padding: 8px 16px;
        border: 2px solid #e5e7eb;
        background: white;
        border-radius: 20px;
        font-weight: 500;
        transition: all 0.3s ease;
        cursor: pointer;
    }
    
    .filter-btn.active {
        background: #3b82f6;
        border-color: #3b82f6;
        color: white;
    }
    
    .filter-btn:hover {
        border-color: #3b82f6;
        color: #3b82f6;
    }
    
    .filter-btn.active:hover {
        color: white;
    }
    
    /* Customização do FullCalendar */
    .fc {
        font-family: inherit;
    }
    
    .fc-toolbar {
        margin-bottom: 20px;
    }
    
    .fc-toolbar-title {
        font-size: 1.5rem;
        font-weight: 600;
        color: var(--dark-color);
    }
    
    .fc-button {
        background: #3b82f6;
        border-color: #3b82f6;
        border-radius: 8px;
        font-weight: 500;
        padding: 8px 16px;
    }
    
    .fc-button:hover {
        background: #1d4ed8;
        border-color: #1d4ed8;
    }
    
    .fc-button:focus {
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.3);
    }
    
    .fc-daygrid-day {
        border: 1px solid #f1f5f9;
    }
    
    .fc-daygrid-day:hover {
        background: #f8fafc;
    }
    
    .fc-day-today {
        background: #f0f9ff !important;
    }
    
    .fc-event {
        border-radius: 6px;
        border: none;
        padding: 2px 6px;
        font-size: 0.85rem;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.3s ease;
    }
    
    .fc-event:hover {
        transform: translateY(-1px);
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
    }
    
    .fc-event-title {
        font-weight: 600;
    }
    
    .legend {
        display: flex;
        gap: 20px;
        align-items: center;
        flex-wrap: wrap;
        margin-top: 20px;
        padding: 20px;
        background: #f8fafc;
        border-radius: 10px;
    }
    
    .legend-item {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 0.9rem;
    }
    
    .legend-color {
        width: 16px;
        height: 16px;
        border-radius: 4px;
    }
    
    .stats-row {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }
    
    .stat-card {
        background: white;
        padding: 20px;
        border-radius: 15px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        text-align: center;
        border-top: 4px solid #3b82f6;
    }
    
    .stat-card.warning {
        border-top-color: var(--warning-color);
    }
    
    .stat-card.success {
        border-top-color: var(--success-color);
    }
    
    .stat-card.info {
        border-top-color: #06b6d4;
    }
    
    .stat-value {
        font-size: 2rem;
        font-weight: 700;
        color: var(--dark-color);
        margin: 0;
    }
    
    .stat-label {
        color: var(--secondary-color);
        font-size: 0.9rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-top: 5px;
    }
    
    @media (max-width: 768px) {
        .calendar-header {
            flex-direction: column;
            align-items: stretch;
        }
        
        .calendar-filters {
            justify-content: center;
        }
        
        .legend {
            flex-direction: column;
            align-items: stretch;
            gap: 10px;
        }
        
        .fc-toolbar {
            flex-direction: column;
            gap: 10px;
        }
        
        .fc-toolbar-chunk {
            display: flex;
            justify-content: center;
        }
    }
</style>
{% endblock %}

{% block admin_content %}
<!-- Estatísticas do Calendário -->
<div class="stats-row">
    <div class="stat-card">
        <h3 class="stat-value" id="totalOrders">0</h3>
        <div class="stat-label">Total de Pedidos</div>
    </div>
    <div class="stat-card warning">
        <h3 class="stat-value" id="thisWeekOrders">0</h3>
        <div class="stat-label">Esta Semana</div>
    </div>
    <div class="stat-card success">
        <h3 class="stat-value" id="completedOrders">0</h3>
        <div class="stat-label">Entregues</div>
    </div>
    <div class="stat-card info">
        <h3 class="stat-value" id="urgentOrders">0</h3>
        <div class="stat-label">Urgentes</div>
    </div>
</div>

<!-- Container do Calendário -->
<div class="calendar-container">
    <div class="calendar-header">
        <div>
            <h2 class="mb-0">
                <i class="fas fa-calendar-alt text-primary me-2"></i>
                Calendário de Pedidos
            </h2>
            <p class="text-muted mb-0">Visualize prazos e entregas dos pedidos</p>
        </div>
        
        <div class="calendar-filters">
            <button class="filter-btn active" data-filter="all">
                Todos
            </button>
            <button class="filter-btn" data-filter="aprovado">
                Aprovados
            </button>
            <button class="filter-btn" data-filter="em_producao">
                Em Produção
            </button>
            <button class="filter-btn" data-filter="pronto">
                Prontos
            </button>
            <button class="filter-btn" data-filter="entregue">
                Entregues
            </button>
        </div>
    </div>
    
    <!-- Calendário -->
    <div id="calendar"></div>
    
    <!-- Legenda -->
    <div class="legend">
        <div class="legend-item">
            <div class="legend-color" style="background: #3788d8;"></div>
            <span>Aprovado</span>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background: #6366f1;"></div>
            <span>Em Produção</span>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background: #10b981;"></div>
            <span>Pronto</span>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background: #4f5553;"></div>
            <span>Entregue</span>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background: #ef4444;"></div>
            <span>Atrasado</span>
        </div>
    </div>
</div>

<!-- Modal de Detalhes do Pedido -->
<div class="modal fade" id="orderModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-info-circle me-2"></i>
                    Detalhes do Pedido
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="orderModalBody">
                <!-- Conteúdo será carregado dinamicamente -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    Fechar
                </button>
                <a href="#" class="btn btn-primary" id="viewOrderBtn">
                    <i class="fas fa-eye me-2"></i>Ver Detalhes Completos
                </a>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
{{ super() }}
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/locales/pt-br.global.min.js"></script>
<script>
let calendar;
let allEvents = [];
let currentFilter = 'all';

$(document).ready(function() {
    initializeCalendar();
    loadCalendarData();
    setupFilters();
});

function initializeCalendar() {
    const calendarEl = document.getElementById('calendar');
    
    calendar = new FullCalendar.Calendar(calendarEl, {
        locale: 'pt-br',
        initialView: 'dayGridMonth',
        headerToolbar: {
            left: 'prev,next today',
            center: 'title',
            right: 'dayGridMonth,dayGridWeek,listWeek'
        },
        buttonText: {
            today: 'Hoje',
            month: 'Mês',
            week: 'Semana',
            list: 'Lista'
        },
        height: 'auto',
        events: [],
        eventClick: function(info) {
            showOrderDetails(info.event);
        },
        eventDidMount: function(info) {
            // Adicionar tooltip
            info.el.setAttribute('title', 
                `${info.event.title}\nStatus: ${info.event.extendedProps.status}\nClique para ver detalhes`
            );
        },
        dayCellDidMount: function(info) {
            // Destacar hoje
            if (info.date.toDateString() === new Date().toDateString()) {
                info.el.style.backgroundColor = '#f0f9ff';
            }
        }
    });
    
    calendar.render();
}

function loadCalendarData() {
    $.get('/admin/api/calendario', function(data) {
        allEvents = data;
        updateCalendar();
        updateStats();
    }).fail(function() {
        console.error('Erro ao carregar dados do calendário');
    });
}

function updateCalendar() {
    let filteredEvents = allEvents;
    
    if (currentFilter !== 'all') {
        filteredEvents = allEvents.filter(event => 
            event.extendedProps.status === currentFilter
        );
    }
    
    // Verificar se está atrasado
    const today = new Date();
    filteredEvents = filteredEvents.map(event => {
        const eventDate = new Date(event.start);
        if (eventDate < today && event.extendedProps.status !== 'entregue') {
            event.backgroundColor = '#4f5553';
            event.borderColor = '#4f5553';
        }
        return event;
    });
    
    calendar.removeAllEvents();
    calendar.addEventSource(filteredEvents);
}

function updateStats() {
    const total = allEvents.length;
    
    // Esta semana
    const startOfWeek = new Date();
    startOfWeek.setDate(startOfWeek.getDate() - startOfWeek.getDay());
    const endOfWeek = new Date(startOfWeek);
    endOfWeek.setDate(endOfWeek.getDate() + 6);
    
    const thisWeek = allEvents.filter(event => {
        const eventDate = new Date(event.start);
        return eventDate >= startOfWeek && eventDate <= endOfWeek;
    }).length;
    
    // Entregues
    const completed = allEvents.filter(event => 
        event.extendedProps.status === 'entregue'
    ).length;
    
    // Urgentes (próximos 3 dias)
    const urgentDate = new Date();
    urgentDate.setDate(urgentDate.getDate() + 3);
    const urgent = allEvents.filter(event => {
        const eventDate = new Date(event.start);
        return eventDate <= urgentDate && 
               event.extendedProps.status !== 'entregue';
    }).length;
    
    $('#totalOrders').text(total);
    $('#thisWeekOrders').text(thisWeek);
    $('#completedOrders').text(completed);
    $('#urgentOrders').text(urgent);
}

function setupFilters() {
    $('.filter-btn').on('click', function() {
        $('.filter-btn').removeClass('active');
        $(this).addClass('active');
        currentFilter = $(this).data('filter');
        updateCalendar();
    });
}

function showOrderDetails(event) {
    const props = event.extendedProps;
    
    const modalBody = $('#orderModalBody');
    modalBody.html(`
        <div class="row">
            <div class="col-md-6">
                <h6><i class="fas fa-building me-2"></i>Empresa</h6>
                <p class="fw-bold">${event.title}</p>
                
                <h6><i class="fas fa-calendar me-2"></i>Data do Pedido</h6>
                <p>${new Date(props.order_date).toLocaleDateString('pt-BR')}</p>
                
                <h6><i class="fas fa-truck me-2"></i>Data de Entrega</h6>
                <p>${new Date(event.start).toLocaleDateString('pt-BR')}</p>
            </div>
            <div class="col-md-6">
                <h6><i class="fas fa-hashtag me-2"></i>Número do Pedido</h6>
                <p>#${props.order_id}</p>
                
                <h6><i class="fas fa-info-circle me-2"></i>Status</h6>
                <p>
                    <span class="badge bg-primary">${getStatusLabel(props.status)}</span>
                </p>
                
                <h6><i class="fas fa-clock me-2"></i>Prazo</h6>
                <p>${calculateDaysLeft(event.start)}</p>
            </div>
        </div>
    `);
    
    $('#viewOrderBtn').attr('href', `/admin/pedidos/${props.order_id}/detalhes`);
    $('#orderModal').modal('show');
}

function getStatusLabel(status) {
    const labels = {
        'aprovado': 'Aprovado',
        'em_producao': 'Em Produção',
        'pronto': 'Pronto',
        'entregue': 'Entregue'
    };
    return labels[status] || status;
}

function calculateDaysLeft(dateString) {
    const eventDate = new Date(dateString);
    const today = new Date();
    const diffTime = eventDate - today;
    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
    
    if (diffDays < 0) {
        return `<span class="text-danger">${Math.abs(diffDays)} dias atrasado</span>`;
    } else if (diffDays === 0) {
        return '<span class="text-warning">Entrega hoje</span>';
    } else if (diffDays <= 3) {
        return `<span class="text-warning">${diffDays} dias restantes</span>`;
    } else {
        return `${diffDays} dias restantes`;
    }
}

// Auto-refresh a cada 5 minutos
setInterval(function() {
    if (!document.hidden) {
        loadCalendarData();
    }
}, 300000);
</script>
{% endblock %}

