{% extends "admin/base.html" %}

{% block page_title %}Gerenciar Permissões de Status{% endblock %}

{% block admin_content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <!-- Cabeçalho da página -->
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h2 class="mb-1">
                        <i class="fas fa-users-cog me-2 text-primary"></i>
                        Gerenciar Permissões de Status
                    </h2>
                    <p class="text-muted mb-0">
                        Configure quais funcionários podem alterar cada status de pedido
                    </p>
                </div>
                <div>
                    <a href="{{ url_for('admin.dashboard') }}" class="btn btn-outline-secondary">
                        <i class="fas fa-arrow-left me-2"></i>Voltar ao Dashboard
                    </a>
                </div>
            </div>

            <!-- Card principal -->
            <div class="card shadow-sm">
                <div class="card-header bg-primary text-white">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-cogs me-2"></i>
                        Configuração de Permissões
                    </h5>
                </div>
                <div class="card-body">
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        <strong>Como usar:</strong> Marque as caixas para habilitar a permissão correspondente. 
                        As alterações são salvas automaticamente quando você marca/desmarca uma opção.
                    </div>

                    {% if employees %}
                        <div class="table-responsive">
                            <table class="table table-bordered table-hover">
                                <thead class="table-dark">
                                    <tr>
                                        <th style="width: 200px;">Funcionário</th>
                                        {% for status in available_statuses %}
                                            <th class="text-center" style="width: 150px;">
                                                {% if status == 'aprovado' %}
                                                    <i class="fas fa-check-circle text-primary"></i><br>Aprovado
                                                {% elif status == 'em_producao' %}
                                                    <i class="fas fa-cogs text-warning"></i><br>Em Produção
                                                {% elif status == 'pronto' %}
                                                    <i class="fas fa-check text-success"></i><br>Pronto
                                                {% elif status == 'entregue' %}
                                                    <i class="fas fa-truck text-info"></i><br>Entregue
                                                {% endif %}
                                            </th>
                                        {% endfor %}
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for employee in employees %}
                                        <tr>
                                            <td>
                                                <div class="d-flex align-items-center">
                                                    <div class="user-avatar me-3">
                                                        {{ employee.username[0].upper() }}
                                                    </div>
                                                    <div>
                                                        <strong>{{ employee.username }}</strong>
                                                        <br>
                                                        <small class="text-muted">ID: {{ employee.id }}</small>
                                                    </div>
                                                </div>
                                            </td>
                                            {% for status in available_statuses %}
                                                <td class="text-center">
                                                    <div class="form-check form-switch d-flex justify-content-center">
                                                        <input class="form-check-input permission-toggle" 
                                                               type="checkbox" 
                                                               id="permission_{{ employee.id }}_{{ status }}"
                                                               data-employee-id="{{ employee.id }}"
                                                               data-status="{{ status }}"
                                                               {% if permissions[employee.id][status] %}checked{% endif %}>
                                                    </div>
                                                </td>
                                            {% endfor %}
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>

                        <!-- Resumo das permissões -->
                        <div class="mt-4">
                            <h6><i class="fas fa-chart-pie me-2"></i>Resumo das Permissões</h6>
                            <div class="row">
                                {% for status in available_statuses %}
                                    <div class="col-md-3 mb-2">
                                        <div class="card bg-light">
                                            <div class="card-body text-center py-2">
                                                <small class="text-muted">{{ status.replace('_', ' ').title() }}</small>
                                                <div class="h5 mb-0" id="count_{{ status }}">
                                                    {{ permissions.values() | selectattr(status) | selectattr(status, 'equalto', True) | list | length }}
                                                </div>
                                                <small class="text-muted">funcionários</small>
                                            </div>
                                        </div>
                                    </div>
                                {% endfor %}
                            </div>
                        </div>
                    {% else %}
                        <div class="alert alert-warning text-center">
                            <i class="fas fa-exclamation-triangle fa-2x mb-3"></i>
                            <h5>Nenhum funcionário ativo encontrado</h5>
                            <p class="mb-0">Adicione funcionários primeiro para configurar suas permissões.</p>
                            <a href="{{ url_for('admin.add_employee') }}" class="btn btn-primary mt-3">
                                <i class="fas fa-plus me-2"></i>Adicionar Funcionário
                            </a>
                        </div>
                    {% endif %}
                </div>
            </div>

            <!-- Botões de ação -->
            <div class="mt-4 text-center">
                <a href="{{ url_for('admin.employees') }}" class="btn btn-outline-primary me-3">
                    <i class="fas fa-users me-2"></i>Gerenciar Funcionários
                </a>
                <a href="{{ url_for('admin.status') }}" class="btn btn-outline-info me-3">
                    <i class="fas fa-tasks me-2"></i>Gerenciar Status
                </a>
                <a href="{{ url_for('admin.dashboard') }}" class="btn btn-secondary">
                    <i class="fas fa-home me-2"></i>Voltar ao Dashboard
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Toast para notificações -->
<div class="position-fixed bottom-0 end-0 p-3" style="z-index: 1050;">
    <div id="statusToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="toast-header">
            <i class="fas fa-bell me-2 text-primary"></i>
            <strong class="me-auto">Notificação</strong>
            <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
        <div class="toast-body" id="toastMessage">
            <!-- Mensagem será inserida aqui -->
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
{{ super() }}
<script>
$(document).ready(function() {
    // Manipular mudanças nas permissões
    $('.permission-toggle').change(function() {
        const employeeId = $(this).data('employee-id');
        const status = $(this).data('status');
        const canChange = $(this).is(':checked');
        const checkbox = $(this);
        
        // Desabilitar checkbox temporariamente
        checkbox.prop('disabled', true);
        
        // Enviar requisição AJAX
        $.ajax({
            url: '{{ url_for("admin.update_status_permissions") }}',
            method: 'POST',
            data: {
                employee_id: employeeId,
                status: status,
                can_change: canChange
            },
            success: function(response) {
                if (response.success) {
                    showToast(response.message, 'success');
                    updateStatusCount(status);
                } else {
                    // Reverter checkbox em caso de erro
                    checkbox.prop('checked', !canChange);
                    showToast(response.message, 'error');
                }
            },
            error: function() {
                // Reverter checkbox em caso de erro
                checkbox.prop('checked', !canChange);
                showToast('Erro ao atualizar permissão. Tente novamente.', 'error');
            },
            complete: function() {
                // Reabilitar checkbox
                checkbox.prop('disabled', false);
            }
        });
    });
    
    function updateStatusCount(status) {
        // Contar checkboxes marcados para este status
        const count = $(`.permission-toggle[data-status="${status}"]:checked`).length;
        $(`#count_${status}`).text(count);
    }
    
    function showToast(message, type) {
        const toastElement = document.getElementById('statusToast');
        const toastMessage = document.getElementById('toastMessage');
        
        // Definir cor baseada no tipo
        toastElement.className = 'toast';
        if (type === 'success') {
            toastElement.classList.add('bg-success', 'text-white');
        } else {
            toastElement.classList.add('bg-danger', 'text-white');
        }
        
        toastMessage.textContent = message;
        
        // Mostrar toast usando Bootstrap 5
        const toast = new bootstrap.Toast(toastElement);
        toast.show();
        
        // Remover classes de cor após esconder
        toastElement.addEventListener('hidden.bs.toast', function() {
            toastElement.classList.remove('bg-success', 'bg-danger', 'text-white');
        });
    }
    
    // Adicionar efeito visual nos switches
    $('.permission-toggle').on('change', function() {
        const row = $(this).closest('tr');
        if ($(this).is(':checked')) {
            row.addClass('table-success').removeClass('table-light');
        } else {
            row.removeClass('table-success');
        }
        
        // Efeito temporário
        setTimeout(() => {
            row.removeClass('table-success');
        }, 1000);
    });
    
    // Tooltip para explicar as permissões
    $('[data-bs-toggle="tooltip"]').tooltip();
});
</script>
{% endblock %}

